<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="../css/nav.css">
    <link rel="stylesheet" href="../css/styleInventory.css">
    <link rel="icon" type="image/png" href="/src/IMG/IN.png">

    <style>
        /* Hide admin navigation by default for security */
        .nav-link[title="Orders"],
        .nav-link[title="POS"],
        .nav-link[title="Menu"],
        .nav-link[title="Reports"],
        .nav-link[title="Users"],
        .nav-link[title="Settings"] {
            display: none !important;
        }

        .upload-dropzone {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: border-color 0.3s ease;
            cursor: pointer;
        }

        .upload-dropzone:hover,
        .upload-dropzone.dragover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }

        .upload-instructions {
            background-color: #e9ecef;
            border-radius: 5px;
            padding: 15px;
        }

        .upload-instructions ul {
            margin-bottom: 0;
            padding-left: 20px;
        }

        .upload-area {
            margin: 20px 0;
        }

        .progress {
            height: 25px;
        }

        .progress-bar {
            transition: width 0.5s ease;
        }
    </style>
</head>

<body>
    <div class="dashboard-container d-flex">
        <aside id="sidebar" class="sidebar d-flex flex-column align-items-center py-3">
            <button id="burgerBtn" class="btn btn-outline-light d-md-none mb-3">
                <i class="bi bi-list"></i>
            </button>
            <div class="brand mb-1">
                <img src="../src/Canva Scratch (3).png" class="rounded-circle" alt="Logo">
            </div>
            <nav class="nav flex-column w-100 text-center">
                <a href="../html/Dashboard.html" class="nav-link text-white" title="Home" id="homeNavLink">
                    <img src="../src/Icons/home.png" alt="Home" class="nav-icon">
                    <div class="nav-text">Home</div>
                </a>

                <a class="nav-link text-white" title="Notifications" style="position:relative;">
                    <img src="../src/Icons/bell.png" alt="Notifications" class="nav-icon">
                    <span class="notification-badge"
                        style="display:none;position:absolute;top:6px;right:12px;background:#e53935;color:#fff;border-radius:50%;padding:2px 7px;font-size:0.85rem;font-weight:700;z-index:2;"></span>
                    <div class="nav-text">Notifications</div>
                </a>

                <a href="../html/Order.html" class="nav-link text-white" title="Orders">
                    <img src="../src/Icons/shopping-bag.png" alt="Sales" class="nav-icon">
                    <div class="nav-text">Orders</div>
                </a>
                <a href="../html/pos.html" class="nav-link text-white" title="POS">
                    <img src="../src/Icons/cashier-machine.png" alt="POS" class="nav-icon">
                    <div class="nav-text">POS</div>
                </a>
                <a href="../html/menu.html" class="nav-link text-white" title="Menu">
                    <img src="../src/Icons/menu (1).png" alt="Menu" class="nav-icon">
                    <div class="nav-text">Menu</div>
                </a>
                <a href="../html/Inventory.html" class="nav-link text-white" title="Inventory">
                    <img src="../src/Icons/inventory.png" alt="Inventory" class="nav-icon">
                    <div class="nav-text">Inventory</div>
                </a>
                <a href="../html/analytics.html" class="nav-link text-white" title="Reports">
                    <img src="../src/Icons/bars.png" alt="reports" class="nav-icon">
                    <div class="nav-text">Reports</div>
                </a>
                <a href="../html/user.html" class="nav-link text-white" title="Users">
                    <img src="../src/Icons/user.png" alt="user" class="nav-icon">
                    <div class="nav-text">Users</div>
                </a>

                <div style="flex-grow: 1;"></div>
                <a href="../html/Settings.html" class="nav-link text-white" title="Settings">
                    <img src="../src/Icons/setting.png" alt="Settings" class="nav-icon">
                    <div class="nav-text">Settings</div>
                </a>
                <a href="#" id="logoutBtn" class="nav-link text-white" title="Logout">
                    <img src="../src/Icons/log-out.png" alt="Logout" class="nav-icon">
                    <div class="nav-text">Logout</div>
                </a>
            </nav>
            <!-- Notification Dropdown UI (anchored to nav/sidebar) -->
            <div id="notificationDropdown" class="notification-dropdown"
                style="display:none;position:absolute;top:80px;left:120px;width:370px;background:#fff;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,0.12);z-index:1000;">
                <div class="dropdown-header p-3 border-bottom d-flex align-items-center justify-content-between">
                    <img src="../src/Icons/bell.png" alt="Notifications"
                        style="width:32px;height:32px;object-fit:contain;filter:brightness(1.2);">
                    <span style="font-weight:600;font-size:1.1rem;margin-left:8px;">Notifications</span>
                    <img src="../src/Icons/close.png" id="closeDropdown" alt="Close"
                        style="width:24px;height:24px;cursor:pointer;filter:grayscale(1) brightness(0.6);">
                </div>
                <div class="dropdown-body p-2" id="dropdownNotificationsList">
                    <!-- Notifications will be loaded here dynamically -->
                    <div class="text-center text-muted py-3">No notifications</div>
                </div>
                <div class="dropdown-footer p-2 text-center border-top">
                    <a href="../html/notifi.html" class="see-all-link"
                        style="color:#4361EE;font-weight:600;text-decoration:none;">See all incoming activity</a>
                </div>
            </div>
        </aside>

        <main class="main-content flex-grow-1 p-4">

            <div class="header-action-row d-flex justify-content-between align-items-center mb-4">

                <div class="inventory-header">
                    <h1 class="inventory-title">Inventory</h1>
                    <p class="inventory-subtitle">0 registered items</p>
                </div>


                <div class="action-bar d-flex align-items-center">
                    <div class="action-buttons d-flex gap-3 me-4">
                        <div class="dropdown">
                            <button class="btn btn-outline-primary action-btn dropdown-toggle" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <img src="../src/Icons/report.png" alt="Report" class="report-icon">
                                Generate Report
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" id="generateGeneralReport">
                                        <i class="fas fa-file-alt me-2"></i>
                                        General Report
                                    </a></li>
                                <li><a class="dropdown-item" href="#" id="generateRestockReport">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        Restock Needed (includes Empty Items)
                                    </a></li>
                            </ul>
                        </div>
                        <button class="btn btn-outline-success action-btn" id="uploadRestockBtn">
                            <img src="../src/Icons/file-upload.png" alt="Upload" class="upload-icon">Upload Ingredients
                        </button>
                        <div class="dropdown">
                            <button id="inventoryEditMenuBtn"
                                class="btn btn-outline-secondary action-btn dropdown-toggle" data-bs-toggle="dropdown"
                                aria-expanded="false">
                                <img src="../src/Icons/edit.png" alt="Edit" class="edit-icon">
                                Edit
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" id="inventoryAddAction">Add Ingredient</a></li>
                                <li><a class="dropdown-item" href="#" id="inventoryEditAction">Edit Selected</a></li>
                            </ul>
                        </div>
                        <select id="inventoryStatusDropdown" class="form-select w-auto ms-2">
                            <option value="all">All</option>
                            <option value="steady">Steady</option>
                            <option value="restock">Restock</option>
                            <option value="empty">Empty</option>
                        </select>
                    </div>

                    <div class="search-container">
                        <div class="search-box">
                            <input type="text" class="form-control search-input" placeholder="Search">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                    </div>
                </div>
            </div>


            <div class="inventory-table-container">

                <table class="table inventory-table" data-restock-threshold="10">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>In-stock</th>
                            <th>Unit of Measure</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryStatus">
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">Loading inventory...</td>
                        </tr>
                    </tbody>
                </table>
            </div>


            <div id="ingredientModal" class="ingredient-modal-overlay" style="display: none;">
                <div class="ingredient-modal">
                    <button class="ingredient-modal-close" aria-label="Close">&times;</button>
                    <h5 class="ingredient-modal-title">Ingredient Details</h5>
                    <form class="ingredient-form" onsubmit="return false;">
                        <div class="ingredient-field">
                            <label for="ingredientName" class="ingredient-label">Name</label>
                            <input id="ingredientName" type="text" class="ingredient-input" placeholder="e.g., Pork">
                        </div>
                        <div class="ingredient-field">
                            <label for="ingredientUom" class="ingredient-label">Unit of Measure</label>
                            <select id="ingredientUom" class="ingredient-select">
                                <option value="">Select unit</option>
                                <option value="grams">Grams</option>
                                <option value="kg">Kg</option>
                                <option value="pcs">Pcs</option>
                                <option value="ml">Ml</option>
                                <option value="l">Liter</option>
                            </select>
                        </div>
                        <div class="ingredient-field">
                            <label for="ingredientQty" class="ingredient-label">Number of Items</label>
                            <input id="ingredientQty" type="number" min="0" class="ingredient-input"
                                placeholder="e.g., 10">
                        </div>
                        <div class="ingredient-actions">
                            <button type="button" id="ingredientSaveBtn" class="ingredient-save-btn">Save</button>
                            <button type="button" id="ingredientDeleteBtn" class="ingredient-delete-btn"
                                style="display: none;">Delete</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Upload Restock Modal -->
            <div id="uploadRestockModal" class="ingredient-modal-overlay" style="display: none;">
                <div class="ingredient-modal">
                    <button class="ingredient-modal-close" id="uploadModalClose" aria-label="Close">&times;</button>
                    <h5 class="ingredient-modal-title">Upload Restock Data</h5>
                    <div class="upload-instructions mb-3">
                        <p><strong>Instructions:</strong></p>
                        <ul>
                            <li>Upload an Excel file (.xlsx) with restock data</li>
                            <li>Required columns: <strong>Item Name</strong>, <strong>Restock Quantity</strong></li>
                            <li>Optional column: <strong>Unit</strong> (to verify units match)</li>
                        </ul>
                    </div>

                    <div class="upload-area">
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                        <div class="upload-dropzone" id="uploadDropzone">
                            <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                            <p class="mb-2">Drag and drop your Excel file here, or</p>
                            <button type="button" class="btn btn-outline-primary" id="selectFileBtn">
                                <i class="fas fa-folder-open me-2"></i>Select File
                            </button>
                        </div>
                        <div id="fileInfo" class="mt-3" style="display: none;">
                            <p class="mb-2"><strong>Selected file:</strong> <span id="fileName"></span></p>
                        </div>
                    </div>

                    <div class="upload-actions mt-4">
                        <button type="button" id="uploadProcessBtn" class="btn btn-success me-2" disabled>
                            <i class="fas fa-upload me-2"></i>Process Upload
                        </button>
                        <button type="button" id="downloadTemplateBtn" class="btn btn-outline-info">
                            <i class="fas fa-download me-2"></i>Download Template
                        </button>
                    </div>

                    <div id="uploadProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <p class="mt-2 text-center" id="progressText">Processing...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>

    <!-- SheetJS library for Excel file generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script src="../javascript/navnotifi.js"></script>
    <script src="../main.js"></script>
    <script src="../javascript/auth-manager.js"></script>
    <script src="../javascript/inventory.js"></script>
    <script src="../javascript/notifications.js"></script>

    <!-- Role-based navigation control -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            firebase.auth().onAuthStateChanged(async function (user) {
                if (!user) {
                    window.location.href = '/html/login.html';
                    return;
                }

                // Get user role from Firestore
                const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                const userData = userDoc.data();

                // If user is admin, show admin navigation items
                if (userData && userData.role === 'admin') {
                    // Show admin navigation items for admin users
                    const adminNavItems = [
                        'Orders', 'POS', 'Menu', 'Reports', 'Users', 'Settings'
                    ];

                    adminNavItems.forEach(title => {
                        const navLink = document.querySelector(`.nav-link[title="${title}"]`);
                        if (navLink) {
                            navLink.style.display = 'block';
                        }
                    });
                }
                // If user is kitchen staff, show kitchen navigation but keep full inventory functionality
                else if (userData && userData.role === 'kitchen') {
                    // Update home link to go to kitchen
                    const homeLink = document.getElementById('homeNavLink');
                    if (homeLink) {
                        homeLink.href = '../html/kitchen.html';
                    }

                    // Keep all inventory functionality - kitchen users can manage inventory
                    // No restrictions on inventory management for kitchen users
                }
            });
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var notifLink = document.querySelector('.nav-link[title="Notifications"]');
            if (notifLink) {
                notifLink.addEventListener('click', function () {
                    if (typeof loadNotifications === 'function') {
                        loadNotifications();
                    }
                });
            }

            // Logout functionality
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        });

        // Logout functionality
        function handleLogout() {
            firebase.auth().signOut().then(() => {
                console.log('User signed out successfully');
                window.location.href = '../index.html';
            }).catch((error) => {
                console.error('Error signing out:', error);
                window.location.href = '../index.html';
            });
        }
    </script>
</body>

</html>